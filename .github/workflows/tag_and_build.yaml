name: Bump version

on:
  pull_request:
    branches:
      - main
    types: [ closed ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Check out the repo
      uses: actions/checkout@v4

    - name: event_number
      shell: bash
      run: |
        echo "PR-number=${{ github.event.pull_request.number }}"

  tag:
    if: github.event.pull_request.merged == true
    name: bump tags
    outputs:
      part: ${{ steps.bump_tag.outputs.part }}
      tag: ${{ steps.bump_tag.outputs.tag }}
      new_tag: ${{ steps.bump_tag.outputs.new_tag }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: '0'
    - name: Bump version and push tag
      id: bump_tag
      uses: anothrNick/github-tag-action@1.62.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WITH_V: true
        DEFAULT_BUMP: patch
        INITIAL_VERSION: '2.0.0'
        TAG_CONTEXT: branch

  debug:
    needs: tag
    if: needs.tag.outputs.part != ''
    runs-on: ubuntu-latest
    steps:
      - name: event_number
        shell: bash
        run: |
          echo "PR-number=${{ github.event.pull_request.number }}"
          echo "github_ref=$GITHUB_REF"
          echo "tag=${{ needs.tag.outputs.tag }}"
          echo "part=${{ needs.tag.outputs.part }}"

  # push_to_registry:
  #   needs: tag
  #   if: needs.tag.outputs.part != ''
  #   name: Push Docker image to Docker Hub
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     packages: write
  #   steps:
  #     - name: Check out the repo
  #       uses: actions/checkout@v4

  #     - name: Log in to the Github Container registry
  #       uses: docker/login-action@v2
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}

  #     - name: Extract metadata (tags, labels) for Docker
  #       id: meta
  #       uses: docker/metadata-action@v4
  #       with:
  #         images: ghcr.io/${{ github.repository }}
  #         tags: |
  #           type=semver,pattern={{raw}},value=${{ needs.tag.outputs.tag }}
  #           type=sha

  #     - name: Build and push
  #       uses: docker/build-push-action@v4
  #       with:
  #         context: .
  #         file: ./Dockerfile
  #         push: false
  #         tags: ${{ steps.meta.outputs.tags }}
  #         labels: ${{ steps.meta.outputs.labels }}

  # bump_chart_version:
  #   needs: [tag, push_to_registry]
  #   if: ${{ needs.tag.outputs.tag != '' && needs.push_to_registry.result == 'success' }}
  #   permissions:
  #     contents: write
  #     pull-requests: write
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Install PyBump
  #       run: |
  #         python3 -m pip install pybump
  #       shell: bash

  #     - name: Automated Version Bump
  #       id: version-bump
  #       run: |
  #         echo -n "Latest tag: ${{ needs.tag.outputs.tag }}" > README.md
  #       shell: bash

  #     - name: Create Pull Request
  #       uses: peter-evans/create-pull-request@v5
  #       with:
  #         token: ${{ secrets.GITHUB_TOKEN }}
  #         commit-message: Bump chart version
  #         committer: GitHub <noreply@github.com>
  #         author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
  #         signoff: false
  #         branch: bump
  #         delete-branch: true
  #         title: "Bump chart version and set appVersion to: ${{ needs.tag.outputs.tag }}"
  #         body: |
  #           Update report
  #           - Updated with *today's* date
  #           - Auto-generated by [create-pull-request][1]
  #         labels: |
  #           automated pr
  #         draft: false
